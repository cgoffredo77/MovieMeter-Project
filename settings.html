<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="settings.css">
</head>
<body>
    <div class="settings-container">
        <h1>Account Settings</h1>
        <form id="settingsForm">
            <div class="form-group">
                <label for="firstName">First Name:</label>
                <input type="text" id="firstName" name="firstName" placeholder="Enter your first name">
            </div>
            <div class="form-group">
                <label for="lastName">Last Name:</label>
                <input type="text" id="lastName" name="lastName" placeholder="Enter your last name">
            </div>
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" placeholder="Enter your username">
            </div>
            <button type="submit" class="save-button">Save Changes</button>
            <button id="backToProfileButton" class="back-button" type="button">Back to Profile</button>
        </form>
    </div>

    <script>
        const BIN_ID = '67056e6aacd3cb34a89381d3'; // Replace with your JSONBin ID
        const MASTER_KEY = '$2a$10$qPie9WKKqWYtoMxhQpLEfeVOf.dI4K750AzEo7MrAWgzb2d0Cpe6m'; // Replace with your Master Key

        // Get signed-in user data from localStorage
        const signedInUser = JSON.parse(localStorage.getItem('signedInUser'));

        // Pre-fill form fields with current user info
        document.getElementById('firstName').value = signedInUser.firstName || '';
        document.getElementById('lastName').value = signedInUser.lastName || '';
        document.getElementById('username').value = signedInUser.username || '';

        // Fetch all user data from JSONBin
        async function fetchAllUsers() {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                headers: {
                    'X-Master-Key': MASTER_KEY
                }
            });
            const data = await response.json();
            return data.record.users;
        }

        // Update user info in JSONBin
        async function updateUserInfo(updatedUser) {
            const allUsers = await fetchAllUsers();

            // Find and update the user in the users array
            const updatedUsers = allUsers.map(user =>
                user.username === signedInUser.username ? { ...user, ...updatedUser } : user
            );

            // Save the updated users array back to JSONBin
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': MASTER_KEY
                },
                body: JSON.stringify({ users: updatedUsers })
            });

            // Update localStorage to reflect the changes
            const newSessionUser = { ...signedInUser, ...updatedUser };
            localStorage.setItem('signedInUser', JSON.stringify(newSessionUser));
            alert('Your information has been successfully updated!');
        }

        // Handle form submission
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Collect updated fields from the form
            const updatedInfo = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                username: document.getElementById('username').value
            };

            try {
                await updateUserInfo(updatedInfo);
            } catch (error) {
                console.error('Error updating user info:', error);
                alert('There was an error updating your information. Please try again.');
            }
        });

        // Redirect to profile page without interfering with the form
        document.getElementById('backToProfileButton').addEventListener('click', () => {
            window.location.href = 'profile.html';
        });
    </script>
</body>
</html>
